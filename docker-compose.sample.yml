version: "3.8"

services:
  # ------------------------------------------------------------------
  # 1. The Mod Updater (Init Container)
  # ------------------------------------------------------------------
  # This service runs FIRST. It downloads/updates mods into the shared volume.
  # When it finishes (exit 0), the actual Minecraft server starts.
  mod-updater:
    image: ghcr.io/aidanfoss/autoupdatedockermc:latest
    # OR build locally:
    # build: .
    volumes:
      # Mount the SAME data directory as the server
      - ./minecraft-data:/data
    environment:
      # Point to the shared volume
      SERVER_DIR: "/data"

      # Configuration
      LOADER: "fabric"
      REQUIRED_MODS: |
        fabric-api
      OPTIONAL_MODS: |
        sodium
        lazydfu
      # Optional: Force a version if you don't want auto-resolution
      # MC_VERSION: "1.20.1"

      # ------------------------------------------------------------------
      # 2. The Minecraft Server (Main Container)
      # ------------------------------------------------------------------
  mc:
    image: itzg/minecraft-server
    depends_on:
      # Wait for the updater to finish successfully before starting
      mod-updater:
        condition: service_completed_successfully
    ports:
      - "25565:25565"
    environment:
      EULA: "TRUE"
      TYPE: "FABRIC"
      # VERSION is read from the file generated by the updater!
    env_file:
      - ./minecraft-data/.mc_version.env
    volumes:
      # Mount the SAME data directory
      - ./minecraft-data:/data
